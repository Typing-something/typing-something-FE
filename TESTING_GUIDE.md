# TESTING_GUIDE.md — TypeSomething

이 문서는 Claude Code가 TypeSomething 프로젝트에 테스트를 추가할 때 반드시 따라야 하는 기준(범위/우선순위/스타일)을 정의한다.  
목표는 “포트폴리오 수준의 신뢰성 증명”이며, 과도한 커버리지는 추구하지 않는다.

---

## 1) 목표

- 핵심 로직(타이핑 지표 계산/진행 흐름/결과 표시)이 **깨지지 않음을 증명**
- 테스트는 **유지보수 가능한 최소 세트**로 구성
- “왜 이 테스트가 필요한지”가 드러나야 한다 (회귀 방지/엣지케이스 방어)

---

## 2) 테스트 범위

### 포함 (필수)
- utils(순수 함수)
- 핵심 hooks 로직 (타이핑 메트릭, 엔진)
- 무한 랜덤 페치 “제어 로직”(중복 방지/종료 조건/fetch 트리거)
- **타자 규칙을 처리하는 입력 엔진 로직**
- TypingStage 사용자 플로우 통합 테스트 1개
- API 래퍼 1개(mock 기반)

### 제외 (원칙)
- 단순 렌더링만 확인하는 UI 테스트
- 스타일/CSS/애니메이션 검증
- Next.js 내부 동작 검증 (라우팅 자체, 프레임워크 동작 등)
- 스냅샷 테스트(특별한 이유 없으면 금지)
- 랜덤 분포/확률 자체의 검증
- 실제 “무한 루프”/실제 네트워크 지연을 전제로 한 테스트

---

## 3) 우선순위 (반드시 이 순서로 진행)

> 아래 1~8 항목을 “테스트 대상 후보”로 고정한다.

1. `parseTypingLine`  
2. “개행(\r\n) 포함 라인 분리/정규화” 관련 유틸  
3. `calcWpmCpm` / `calcAccuracy` 등 지표 계산 유틸(존재한다면)  
4. `useLiveTypingMetrics`  
5. `useLiveTypingEngine`  
6. 무한 랜덤 페치 제어 로직  
7. **타자 규칙(입력 처리 엔진) 테스트**  
8. `TypingStage` 통합 시나리오 1개  
9. `getRanking` API 래퍼 성공/실패 처리

---

## 4) 테스트 스타일 가이드 (중요)

- 테스트 관점: **사용자/결과 중심**
- 구현 디테일(state/ref/내부 변수)에 의존하지 말 것
- 모든 테스트는 Given / When / Then 구조를 가질 것
- 각 테스트 파일 상단에 “이 테스트가 없으면 재발하는 버그”를 1줄로 명시

### 금지
- 의미 없는 snapshot
- 커버리지 목적 테스트
- 과도한 타이머 제어로 flaky 테스트 생성

---

## 5) Mock 규칙

- `fetch` 요청은 반드시 mock
- 외부 라이브러리 mock 최소화
- 시간 의존 로직은 가능한 한 순수 함수로 분리 후 테스트

---

## 6) 파일 구성 규칙

- 테스트 파일명: `*.test.ts` / `*.test.tsx`
- utils / hooks / engine 로직과 가까운 위치에 테스트 배치
- **타자 규칙 테스트는 UI가 아닌 “입력 처리 로직(엔진/순수 함수)” 기준으로 작성**

---

## 7) 각 대상별 “필수 테스트 케이스” 정의

### (1) `parseTypingLine`
- `\r\n` 처리
- 빈 줄/공백 줄
- 연속 공백/특수문자
- 한글/영문 혼합

### (2) 라인 분리/정규화 유틸
- `\n`, `\r\n` 동일 결과
- 마지막 줄 개행 유무 무관
- 빈 라인 포함 시 안정성

### (3) 지표 계산 유틸
- 초기 상태 NaN/Infinity 방지
- 입력 증가 시 지표 변화
- 정확도 0~100 보장

### (4) `useLiveTypingMetrics`
- 시간 흐름에 따른 지표 변화
- `isComposing` 정책 반영
- backspace 시 지표 반영

### (5) `useLiveTypingEngine`
- 완료 조건 충족 시 완료 상태 전환
- 진행 정책 대표 케이스 1~2개

---

### (6) 무한 랜덤 페치 제어 로직

- 중복 없는 랜덤 선택
- 종료 조건
- fetch 트리거
- 초기 상태 안정성

---

### (7) **타자 규칙 기반 입력 처리 테스트 (중요)**

> 이 섹션은 UI가 아닌 **입력 처리 엔진(순수 함수 또는 훅 내부 로직)**을 대상으로 한다.

#### 테스트 대상
- 목표 텍스트(target)
- 현재 입력 상태(state)
- 단일 키 입력(key)

#### 핵심 규칙

##### 1. 띄어쓰기 위치 규칙
- target이 `" "`일 때
  - 입력 `" "` → 정상 진행
  - 입력 `"a"` 등 다른 문자 → 오타 처리 + 진행 불가

##### 2. 글자 위 띄어쓰기
- target이 `"a"`일 때
  - 입력 `" "` → 오타 처리

##### 3. 오타 허용 개수 제한
- 글자 오타는 **최대 5글자까지 허용**
- 6번째 오타 입력 시
  - 입력 무시 / 진행 불가 / locked 상태 (프로젝트 정책에 따름)

##### 4. 오타 제거 규칙
- 오타는 **유저 입력(backspace)**으로만 제거 가능
- 다른 입력으로 자동 제거 ❌

##### 5. 문장부호 처리
- 문장부호(`. , ! ?`)는 일반 글자와 동일 규칙 적용

##### 6. 스페이스바 줄바꿈
- 줄바꿈 토큰이 존재할 경우
  - `space` 입력이 줄바꿈으로 처리되는 정책을 검증

---

### (8) `TypingStage` 통합 시나리오 (1개)

- given: 짧은 lyric
- when: 사용자가 순서대로 입력
- then: 완료 시 결과 상태 또는 ResultModal 노출

---

### (9) `getRanking` API 래퍼

- 성공 응답 가공
- 실패 시 에러/폴백 처리

---

## 8) 산출물 요구사항 (Claude Code용)

- 우선순위 순서대로 테스트 추가
- 각 테스트 파일 상단에 목적 주석 포함
- Jest + RTL + jest-dom 최소 설정 포함
- 스냅샷 테스트 금지
- 테스트가 불안정하면 **설계 개선 제안 후 적용**